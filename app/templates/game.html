<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ä¸ƒä¸¦ã¹</title>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
#hand { margin: 20px; }
.card { display: inline-block; width: 60px; height: 90px; border: 1px solid #000; text-align:center; line-height:90px; margin: 3px; cursor:pointer; }
#table { margin: 20px; }
.suit { margin: 10px 0; }
</style>
</head>
<body>
<h1>æ®µä½æˆ¦</h1>
<div id="table"
     style="
        display: grid;
        grid-template-columns: repeat(13, 60px);
        grid-template-rows: repeat(4, 90px);
        gap: 2px;
        justify-content: center;
        margin-top: 40px;
        background-color: #0b6623;
        padding: 10px;
        border-radius: 8px;
     ">
</div>
    <div class="suit" id="hearts"></div>
    <div class="suit" id="spades"></div>
    <div class="suit" id="diamonds"></div>
    <div class="suit" id="clubs"></div>
</div>
<div id="players-ui" style="margin-top: 12px; font-size: 20px; display:flex; gap:25px; justify-content:center;"></div>

<button id="pass-btn" style="padding: 8px; margin-top: 10px; display: none;">
  ãƒ‘ã‚¹
</button>

<style>
#table {
  display: grid;
  grid-template-columns: repeat(13, 60px);  /* 13åˆ— */
  grid-template-rows: repeat(4, 90px);     /* 4è¡Œ */
  gap: 6px;
  justify-content: center;
  margin-top: 40px auto 20px;
  background-color: #0b6623;
  padding: 12px;
  border-radius: 10px;
  width: fit-content;
  box-sizing: border-box;
}

.slot {
  width: 60px;
  height: 90px;
  background-color: #0a3;
  border: 1px solid #083;
  border-radius: 6px;

  display: flex;
  align-items: center;
  justify-content: center;
}

.card {
  width: 100%;
  height: 100%;
  object-fit: contain;   /* â† ã‚«ãƒ¼ãƒ‰ãŒç¶ºéº—ã«åã¾ã‚‹ */
  pointer-events: none;  /* â† ãƒ‰ãƒ©ãƒƒã‚°é˜²æ­¢ */
}

.hand-card {
  width: 60px;
  height: 90px;
  object-fit: contain;
  cursor: pointer;
  transition: transform 0.15s;
}

.hand-card:hover {
  transform: translateY(-6px);
}

</style>


<h3>ã‚ãªãŸã®æ‰‹æœ­</h3>
<div id="hand"
     style="
        position: fixed;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 5px;
        background-color: rgba(255,255,255,0.2);
        padding: 10px;
        border-radius: 10px;
     ">
</div>
<div id="ranking-ui" style="
    position: absolute;
    right: 20px;
    top: 100px;
    width: 180px;
    padding: 10px;
    border: 1px solid #333;
    background: #fafafa;
"></div>

<script>
const socket = io();

const username = "{{ username }}";
const room = "{{ room_id }}"; // ç°¡æ˜“ç‰ˆ: å›ºå®šãƒ«ãƒ¼ãƒ 

console.log("usename : " + username);
console.log("room_id : " + room);
socket.emit("join_game", {username, room});
const suits = ["H", "S", "D", "K"]; // å„ã‚¹ãƒ¼ãƒˆã‚’ä¸Šã‹ã‚‰é †ã«è¡Œã¨ã—ã¦ä½¿ã†
const suitNames = { H: "hearts", S: "spades", D: "diamonds", K: "clubs" };

let CTurn = null;

function initTable() {
    const table = document.getElementById("table");
    table.innerHTML = "";

    // å„ã‚¹ãƒ¼ãƒˆè¡Œã«13åˆ—ã®ã‚»ãƒ«ã‚’ä½œæˆ
    for (let row = 0; row < suits.length; row++) {
        for (let col = 1; col <= 13; col++) {
            const cell = document.createElement("div");
            cell.id = `${suits[row]}${col}_cell`;
            cell.style.width = "60px";
            cell.style.height = "90px";
            cell.style.border = "1px solid #444";
            cell.style.borderRadius = "6px";
            cell.style.backgroundColor = "rgba(255,255,255,0.1)";
            cell.style.display = "flex";
            cell.style.alignItems = "center";
            cell.style.justifyContent = "center";
            table.appendChild(cell);
        }
    }
}

initTable();

function sortCards(cards) {
    const order = { H: 0, S: 1, D: 2, K: 3 };
    return cards.sort((a, b) => {
        const suitA = order[a[0]];
        const suitB = order[b[0]];
        if (suitA !== suitB) return suitA - suitB;
        return parseInt(a.slice(1)) - parseInt(b.slice(1));
    });
}

socket.on("update_hand", data => {
    if (data.username === username) {
        const handDiv = document.getElementById("hand");
        handDiv.innerHTML = "";
        console.log("ã‚¿ãƒ¼ãƒ³ : ", data.current_turn);
        const currentTurn = data.current_turn;
        const passes = data.passes;
        const playable = new Set(data.playable);
        const sorted = data.hand.sort((a,b) => {
            const n1 = parseInt(a.slice(1)), n2 = parseInt(b.slice(1));
            const s1 = ["D","H","S","K"].indexOf(a[0]);
            const s2 = ["D","H","S","K"].indexOf(b[0]);
            return s1 - s2 || n1 - n2;
        });
        
        console.log("ãƒ‘ã‚¹å›æ•°:" + passes[username]);
        if( playable.length === 0 ){
          console.log("å‡ºã›ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          if( passes[username] === 0 ){
            socket.emit("lose", {player: username});
            return;
          }

        }
        console.log("ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ : " + CTurn);
        const isMyTurn = (CTurn === username);

        sorted.forEach(card => {
            const c = document.createElement("img");
            c.src = `/static/cards/${card}.png`;
            if (!playable.has(card)) {
              c.style.opacity = "0.35";
              c.style.pointerEvents = "none";
            } else {
              c.style.opacity = "1.0";
              c.style.pointerEvents = "auto";
              if( currentTurn === username ){
                c.onclick = () => socket.emit("play_card", { username, room, card });
                
              }else{
                console.log("ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ãªã„");
              }
            }
            c.className = "hand-card";
            //c.onclick = () => socket.emit("play_card", { username, room, card });
            handDiv.appendChild(c);
        });
    }
});

// ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã“ã®é–¢æ•°ã§ #table ã‚’å®Œå…¨ã«ç½®ãæ›ãˆï¼‰
// --- ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ ---
socket.on("update_table", data => {
  console.log("ğŸ“¥ update_table:", data);

  const table = data.table;
  if (!table) return;

  const suits = ["hearts", "spades", "diamonds", "clubs"]; // â† è¡Œæ–¹å‘ã«ä¸¦ã¶
  const tableDiv = document.getElementById("table");
  tableDiv.innerHTML = "";

  // âœ… æ­£ã—ã„ç›¤é¢ï¼š4è¡Œï¼ˆã‚¹ãƒ¼ãƒˆï¼‰ Ã— 13åˆ—ï¼ˆæ•°å­—ï¼‰
  for (let row = 0; row < 4; row++) {
    for (let col = 0; col < 13; col++) {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.id = `cell-r${row}-c${col}`; // â† å¾Œã‹ã‚‰å·®ã—è¾¼ã¿ã‚„ã™ãã™ã‚‹
      tableDiv.appendChild(slot);
    }
  }

  // âœ… table ã®å†…å®¹ã‚’ãã®ã¾ã¾å¯¾å¿œã‚»ãƒ«ã¸å·®ã—è¾¼ã‚€
  suits.forEach((suit, rowIndex) => {
    const cards = table[suit];
    if (!Array.isArray(cards)) return;

    cards.forEach((card, colIndex) => {
      if (!card) return;
      const slot = document.getElementById(`cell-r${rowIndex}-c${colIndex}`);
      if (!slot) return;

      const img = document.createElement("img");
      img.className = "card";
      img.src = `/static/cards/${card}.png`;
      img.alt = card;
      slot.appendChild(img);
    });
  });
});



socket.on("announce_turn", data => {
    const { player, passes, players, hand_counts } = data;  // â† players ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§é€ã‚‹ã‚ˆã†ã«å¤‰æ›´æ¸ˆã¿ã®å‰æ
    const playersUI = document.getElementById("players-ui");
    CTurn = player;
    let html = "";
    players.forEach(p => {
        const isTurn = (p === player);
        const passCount = passes[p] ?? 0;
        const cardsLeft = hand_counts[p] ?? 0;

        html += `
        <div style="text-align:center;">
            <div style="
                font-weight:bold;
                color:${isTurn ? 'red' : 'black'};
                text-decoration:${isTurn ? 'underline' : 'none'};
            ">
                ${p}
            </div>
            <div style="font-size:14px;">
                æ®‹ã‚Šæšæ•° : ${cardsLeft} æš
            </div>
            <div style="font-size:14px;">
                ãƒ‘ã‚¹ : ${passCount} / 3
            </div>
        </div>
        `;
    });

    playersUI.innerHTML = html; 
    console.log("ãƒ‘ã‚¹å›æ•° : " + passes[username]);


    const passBtn = document.getElementById("pass-btn");
    if (player === username) {
    // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®å ´åˆã®ã¿ãƒœã‚¿ãƒ³è¡¨ç¤º
    passBtn.style.display = "inline-block";

    if ((passes[username] ?? 0) < 3) {
        // ãƒ‘ã‚¹å¯èƒ½
        passBtn.innerText = `ãƒ‘ã‚¹ï¼ˆæ®‹ã‚Š ${3 - (passes[username] ?? 0)}ï¼‰`;
        passBtn.onclick = () => {
            console.log("ãƒ‘ã‚¹é€ä¿¡");
            socket.emit("pass_turn", { username, room });
        };
    } else {
        // ãƒ‘ã‚¹3å›ã§é™å‚
        passBtn.innerText = "é™å‚";
        passBtn.onclick = () => {
            console.log("é™å‚é€ä¿¡");
            socket.emit("player_surrender", { username, room });
        };
    }
} else {
    // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã˜ã‚ƒãªã„å ´åˆã¯ãƒœã‚¿ãƒ³éè¡¨ç¤º
    passBtn.style.display = "none";
    passBtn.onclick = null;
}
});

//ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
socket.on("update_ranking", data => {
    const { ranks } = data;

    updateRankingUI(ranks);
});

function updateRankingUI(ranks) {
    const rankUI = document.getElementById("ranking-ui");

    if (!ranks || ranks.length === 0) {
        rankUI.innerHTML = "<b>ç¢ºå®šé †ä½ï¼š</b><br>ãªã—";
        return;
    }

    let html = "<b>ç¢ºå®šé †ä½ï¼š</b><br><br>";

    ranks.forEach((p, i) => {
        html += `${i + 1} ä½ï¼š ${p}<br>`;
    });

    rankUI.innerHTML = html;
}


socket.on("card_played", data => {
    // å ´ã®æ›´æ–°
    for (const suit in data.table) {
        const suitDiv = document.getElementById(suit.toLowerCase());
        suitDiv.textContent = data.table[suit].join(" ");
    }
});
</script>
</body>
</html>
