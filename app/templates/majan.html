<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>éº»é›€ãƒ—ãƒ­ã‚°ãƒ©ãƒ </title>
<style>
  body { font-family: "Segoe UI Emoji", sans-serif; text-align: center; background-color: #fafafa; }
  .tile { font-size: 32px; cursor: pointer; margin: 3px; display: inline-block; }
  .highlight { background-color: yellow; border-radius: 5px; padding: 2px; }
  #hand { margin-top: 15px; }
  #info { margin-top: 20px; font-size: 18px; }
  button { margin: 5px; font-size: 18px; padding: 5px 10px; }
</style>
</head>
<body>
<h1>ğŸ€„ éº»é›€ãƒ—ãƒ­ã‚°ãƒ©ãƒ </h1>

<div>
  <button onclick="deal()">é…ç‰Œã™ã‚‹</button>
  <button onclick="draw()">è‡ªæ‘¸</button>
  <button onclick="sortHand()">ç†ç‰Œã™ã‚‹</button>
</div>

<div id="info"></div>
<div id="dora"></div>
<div id="hand"></div>

<script>
const suits = ["m", "p", "s"]; // è¬å­, ç­’å­, ç´¢å­
const honors = ["æ±", "å—", "è¥¿", "åŒ—", "ç™½", "ç™¼", "ä¸­"];
const emojiMap = {
  "1m":"ğŸ€‡","2m":"ğŸ€ˆ","3m":"ğŸ€‰","4m":"ğŸ€Š","5m":"ğŸ€‹","6m":"ğŸ€Œ","7m":"ğŸ€","8m":"ğŸ€","9m":"ğŸ€",
  "1p":"ğŸ€™","2p":"ğŸ€š","3p":"ğŸ€›","4p":"ğŸ€œ","5p":"ğŸ€","6p":"ğŸ€","7p":"ğŸ€Ÿ","8p":"ğŸ€ ","9p":"ğŸ€¡",
  "1s":"ğŸ€","2s":"ğŸ€‘","3s":"ğŸ€’","4s":"ğŸ€“","5s":"ğŸ€”","6s":"ğŸ€•","7s":"ğŸ€–","8s":"ğŸ€—","9s":"ğŸ€˜",
  "æ±":"ğŸ€€","å—":"ğŸ€","è¥¿":"ğŸ€‚","åŒ—":"ğŸ€ƒ","ç™½":"ğŸ€„","ç™¼":"ğŸ€…","ä¸­":"ğŸ€†"
};

let wall = [];
let hand = [];
let dora = null;

function makeWall() {
  wall = [];
  for (let s of suits) {
    for (let n = 1; n <= 9; n++) {
      for (let i = 0; i < 4; i++) wall.push(n + s);
    }
  }
  for (let h of honors) {
    for (let i = 0; i < 4; i++) wall.push(h);
  }
  shuffle(wall);
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function deal() {
  makeWall();
  hand = wall.splice(0, 13);
  dora = wall.splice(0, 1)[0];
  updateDisplay();
}

function sortHand() {
  const order = "mpsæ±å—è¥¿åŒ—ç™½ç™¼ä¸­";
  hand.sort((a,b)=> order.indexOf(a[a.length-1]) - order.indexOf(b[b.length-1]) || a.localeCompare(b));
  updateDisplay();
}

function draw() {
  if (wall.length === 0) return;
  const newTile = wall.shift();
  hand.push(newTile);
  updateDisplay();
}

function discard(tile) {
  hand.splice(hand.indexOf(tile), 1);
  updateDisplay();
}

function updateDisplay() {
  const handDiv = document.getElementById("hand");
  handDiv.innerHTML = "";
  hand.forEach(t => {
    const span = document.createElement("span");
    span.className = "tile";
    span.textContent = emojiMap[t];
    span.onclick = () => discard(t);
    handDiv.appendChild(span);
  });
  document.getElementById("dora").innerHTML = `ãƒ‰ãƒ©è¡¨ç¤ºç‰Œ: ${emojiMap[dora]}`;
  document.getElementById("info").innerHTML = analyzeHand(hand);
}

function analyzeHand(h) {
  const melds = countMelds([...h]);
  const yaku = detectYaku(h);
  const tenpaiInfo = checkTenpai(h);

  let result = `é¢å­å€™è£œ: ${melds}ã€€å½¹: ${yaku.join(" / ") || "ãªã—"}`;
  if (tenpaiInfo.isTenpai)
    result += `<br><span class='highlight'>è´ç‰Œï¼ å¾…ã¡ç‰Œ: ${tenpaiInfo.waits.map(x=>emojiMap[x]).join(" ")}</span>`;
  else result += "<br>è´ç‰Œã—ã¦ã„ã¾ã›ã‚“";
  return result;
}

// é¢å­ã‚’æ•°ãˆã‚‹ï¼ˆé †å­ï¼‹åˆ»å­ï¼‰
function countMelds(tiles) {
  tiles.sort();
  let count = 0;
  // åˆ»å­
  for (let t of [...new Set(tiles)]) {
    const same = tiles.filter(x=>x===t);
    if (same.length >= 3) {
      count++;
      for (let i=0;i<3;i++) tiles.splice(tiles.indexOf(t),1);
    }
  }
  // é †å­
  for (let s of suits) {
    for (let n=1;n<=7;n++) {
      while(tiles.includes(n+s)&&tiles.includes((n+1)+s)&&tiles.includes((n+2)+s)) {
        count++;
        tiles.splice(tiles.indexOf(n+s),1);
        tiles.splice(tiles.indexOf((n+1)+s),1);
        tiles.splice(tiles.indexOf((n+2)+s),1);
      }
    }
  }
  return count;
}

// å½¹ã®åˆ¤å®š
function detectYaku(tiles) {
  const yaku = [];
  // ã‚¿ãƒ³ãƒ¤ã‚ªï¼š1,9,å­—ç‰ŒãŒãªã„
  if (tiles.every(t => {
    if (honors.includes(t)) return false;
    const num = parseInt(t);
    return num>=2 && num<=8;
  })) yaku.push("ã‚¿ãƒ³ãƒ¤ã‚ª");

  // å½¹ç‰Œ
  if (tiles.filter(t => ["ç™½","ç™¼","ä¸­"].includes(t)).length >= 3)
    yaku.push("å½¹ç‰Œ");

  // ãƒ”ãƒ³ãƒ•ï¼šã™ã¹ã¦é †å­ï¼‹é›€é ­ãŒæ•°ç‰Œï¼ˆç°¡æ˜“ï¼‰
  if (tiles.every(t => !honors.includes(t))) yaku.push("ãƒ”ãƒ³ãƒ•");

  return yaku;
}

// è´ç‰Œãƒã‚§ãƒƒã‚¯
function checkTenpai(tiles) {
  const allTiles = new Set([...wall, ...hand, dora]);
  const waits = [];
  for (let t of allTiles) {
    if (tiles.filter(x=>x===t).length >= 4) continue; // æšæ•°åˆ¶é™
    const newHand = [...tiles, t];
    if (isWinningHand(newHand)) waits.push(t);
  }
  return { isTenpai: waits.length>0, waits };
}

// å’Œäº†åˆ¤å®šï¼š4é¢å­ï¼‹1é›€é ­ï¼ˆ13æš+1ï¼‰
function isWinningHand(tiles) {
  if (tiles.length !== 14) return false;
  tiles.sort();
  for (let i=0; i<tiles.length-1; i++) {
    if (tiles[i] === tiles[i+1]) {
      const rest = tiles.slice(0,i).concat(tiles.slice(i+2));
      if (canFormMelds(rest)) return true;
    }
  }
  return false;
}

function canFormMelds(tiles) {
  if (tiles.length === 0) return true;
  tiles.sort();
  const t = tiles[0];
  const same = tiles.filter(x=>x===t);
  if (same.length >= 3) {
    const newTiles = [...tiles];
    for (let i=0;i<3;i++) newTiles.splice(newTiles.indexOf(t),1);
    if (canFormMelds(newTiles)) return true;
  }
  if (!honors.includes(t)) {
    const num = parseInt(t);
    const suit = t[t.length-1];
    if (tiles.includes((num+1)+suit) && tiles.includes((num+2)+suit)) {
      const newTiles = [...tiles];
      [t,(num+1)+suit,(num+2)+suit].forEach(x=> newTiles.splice(newTiles.indexOf(x),1));
      if (canFormMelds(newTiles)) return true;
    }
  }
  return false;
}
</script>
</body>
</html>
