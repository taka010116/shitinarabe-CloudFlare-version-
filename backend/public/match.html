<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>対局待機</title>
<style>
body {
  font-family: sans-serif;
  background: #f5f5f5;
  text-align: center;
  padding-top: 40px;
}
#box {
  background: white;
  width: 420px;
  margin: auto;
  padding: 20px;
  border-radius: 8px;
}
.player {
  margin: 6px 0;
}
</style>
</head>
<body>

<div id="box">
  <h2>対局待機中</h2>
  <p>現在の待機人数：<b id="count">0</b>人</p>

  <div id="players"></div>

  <p id="status"></p>
</div>

<script>
const user = JSON.parse(localStorage.getItem("user"));
if (!user) location.href = "/login.html";

const ws = new WebSocket(
  `wss://my-worker.6322052.workers.dev/match?user=${encodeURIComponent(user.username)}`
);

let countdownTimer = null;
let countdown = 10;

ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);

  /* ===== 待機状態 ===== */
  if (msg.type === "waiting") {
    document.getElementById("count").textContent = msg.players.length;
    renderPlayers(msg.players);

    // 2人になったら10秒カウント開始
    if (msg.players.length === 2 && !countdownTimer) {
      countdown = 10;
      document.getElementById("status").textContent =
        `あと ${countdown} 秒で対局開始`;
      countdownTimer = setInterval(() => {
        countdown--;
        document.getElementById("status").textContent =
          `あと ${countdown} 秒で対局開始`;
        if (countdown <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
      }, 1000);
    }

    // 3人以上来たら即開始なのでカウント停止
    if (msg.players.length >= 3 && countdownTimer) {
      clearInterval(countdownTimer);
      countdownTimer = null;
      document.getElementById("status").textContent = "";
    }
  }

  /* ===== マッチ成立 ===== */
  if (msg.type === "matched") {
    if (countdownTimer) {
      clearInterval(countdownTimer);
      countdownTimer = null;
    }

    document.getElementById("status").textContent = "対局を開始します…";
    renderPlayers(msg.players);

    // 2秒待って対局画面へ
    setTimeout(() => {
      location.href = `/game.html?room=${msg.roomId}`;
    }, 2000);
  }
};

function renderPlayers(players) {
  const div = document.getElementById("players");
  div.innerHTML = "<h3>マッチング中のプレイヤー</h3>";
  players.forEach(p => {
    const d = document.createElement("div");
    d.className = "player";
    d.textContent = `${p.username} ｜ 段位:${p.dan} ｜ R:${p.rating}`;
    div.appendChild(d);
  });
}
</script>

</body>
</html>
