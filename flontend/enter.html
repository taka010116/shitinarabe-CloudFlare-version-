<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>七並べ ONLINE - ルーム参加</title>
  <style>
    body {
      font-family: sans-serif;
      background: #0a7a3b;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    #login, #waiting {
      max-width: 500px;
      margin: auto;
      background: rgba(0,0,0,0.25);
      padding: 20px;
      border-radius: 8px;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    input, select, button {
      width: 100%;
      margin-top: 5px;
      padding: 8px;
      font-size: 16px;
    }

    button {
      margin-top: 15px;
      cursor: pointer;
    }

    #waiting {
      display: none;
      text-align: center;
    }

    #status {
      margin-top: 15px;
      font-size: 18px;
    }
  </style>
</head>
<body>

<h1>七並べ ONLINE</h1>

<!-- 参加画面 -->
<div id="login">
  <label>
    ユーザー名
    <input id="username" placeholder="例：player1" />
  </label>

  <label>
    ルームID
    <input id="roomId" placeholder="例：room123" />
  </label>

  <label>
    人数（2〜4人）
    <select id="playerCount">
      <option value="2">2人</option>
      <option value="3">3人</option>
      <option value="4">4人</option>
    </select>
  </label>

  <button onclick="connect()">参加する</button>
</div>

<!-- 待機画面 -->
<div id="waiting">
  <h2>待機中</h2>
  <div id="status">接続中...</div>
</div>

<script>
let ws;
let myName = "";
let roomId = "";
let maxPlayers = 0;

function connect() {
  myName = document.getElementById("username").value.trim();
  roomId = document.getElementById("roomId").value.trim();
  maxPlayers = Number(document.getElementById("playerCount").value);

  if (!myName || !roomId) {
    alert("ユーザー名とルームIDを入力してください");
    return;
  }

  const url = `wss://my-worker.6322052.workers.dev/room/${roomId}`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type: "join_game",
      username: myName,
      maxPlayers: maxPlayers
    }));

    document.getElementById("login").style.display = "none";
    document.getElementById("waiting").style.display = "block";
    document.getElementById("status").textContent = "参加者を待っています...";
  };

  ws.onmessage = e => {
    const msg = JSON.parse(e.data);

    // 待機人数更新
    if (msg.type === "waiting") {
      document.getElementById("status").textContent =
        `参加者待機中：${msg.current} / ${msg.max}`;
    }

    // ゲーム開始
    if (msg.type === "game_start") {
      ws.close();

      location.href =
        `game.html?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(myName)}`;
    }

    // エラー
    if (msg.type === "error") {
      alert(msg.message);
      ws.close();
      location.reload();
    }
  };

  ws.onclose = () => {
    console.log("WebSocket closed");
  };

  ws.onerror = () => {
    alert("接続エラーが発生しました");
  };
}
</script>

</body>
</html>
