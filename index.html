<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>七並べ ONLINE</title>

<style>
body {
  font-family: sans-serif;
  background: #0a7a3b;
  color: #fff;
  margin: 0;
  padding: 20px;
}

h1 { text-align: center; }

.panel {
  max-width: 900px;
  margin: auto;
  background: rgba(0,0,0,0.25);
  padding: 20px;
  border-radius: 8px;
}

label { display:block; margin-top:10px; }
input, select, button {
  width:100%; margin-top:5px; padding:8px; font-size:16px;
}
button { margin-top:15px; cursor:pointer; }

#waiting, #game { display:none; }

#game {
  display: none;
  flex-direction: row;
  align-items: flex-start;

  max-width: none !important;
  margin: 0 !important;
  padding: 15px;

  width: 100vw;
  box-sizing: border-box;

  overflow: hidden;   /* ← スクロール完全禁止 */
}

#table {
  display: grid;
  grid-template-columns: repeat(13, 52px);
  grid-template-rows: repeat(4, 78px);
  gap: 4px;
  justify-content: center;
  margin: 30px auto;
  background:#0b6623;
  padding:10px;
  border-radius:10px;
}

.slot {
  width:52px; height:78px;
  background:#0a3;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.hand-card {
  width:68px;
  height:102px;
  cursor:pointer;
  transition:transform .15s;
}
.hand-card:hover { transform:translateY(-8px); }

.game-layout {
  display: flex;
  flex-direction: row; 
  gap: 20px;
  align-items: flex-start;
  width: 100%;
}

.game-main {
  /* flex: 1; */
  flex: 0 0 auto; 
  min-width: 700px;
}

.chat-panel {
  position: fixed;      /* ← レイアウトから完全に切り離す */
  top: 20px;            /* ← 右上からの距離 */
  right: 20px;

  width: 260px;
  height: 520px;

  background: rgba(0,0,0,0.7);
  border-radius: 8px;
  padding: 10px;

  display: none;
  flex-direction: column;

  z-index: 1000;        /* ← ゲームより必ず前 */
}


.chat-panel h3 {
  margin: 0 0 8px 0;
  text-align: center;
}

#chat-log {
  flex: 1;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  padding: 8px;
  overflow-y: auto;
  font-size: 13px;
  line-height: 1.4;
}

#game.panel {
  max-width: none;
}

.chat-box {
  width: 260px;
  height: 520px;
  background: rgba(0,0,0,0.35);
  border-radius: 8px;
  padding: 10px;
  overflow-y: auto;
  flex-shrink: 0;        /* ← 絶対に縮まない */
}

.chat-input {
  flex: 1;                 /* 横に最大限伸ばす */
  height: 36px;            /* 少し高さを出す */
  padding: 0 10px;
  font-size: 14px;
  border-radius: 6px;
  border: none;
}

.chat-send {
  width: 56px;             /* 小さめ */
  height: 32px;
  padding: 0;
  font-size: 13px;
  border-radius: 6px;
  cursor: pointer;
}


</style>
</head>

<body>



<!-- ===== lobby ===== -->
<div id="login" class="panel">
  <label>ユーザー名 <input id="username"></label>
  <label>ルームID <input id="roomId"></label>
  <label>人数
    <select id="playerCount">
      <option value="2">2人</option>
      <option value="3">3人</option>
      <option value="4">4人</option>
    </select>
  </label>
  <button onclick="connect()">参加</button>
</div>

<div id="waiting" class="panel">
  <h2>待機中</h2>
  <div id="status"></div>
</div>

<!-- ===== game ===== -->
<div id="game" class="panel game-layout">

  <!-- ===== 左：ゲーム ===== -->
  <div class="game-main">
    <div id="players-ui" style="display:flex;gap:20px;justify-content:center;"></div>
    <div id="table"></div>
    <h3>あなたの手札</h3>
    <div id="hand" style="display:flex;gap:6px;justify-content:center;"></div>
    <button id="pass-btn" style="display:none;">パス</button>
  </div>

  <!-- ===== 右：チャット ===== -->
  <div class="chat-panel">
    <h3>Chat Log</h3>

    <div id="chat-log"></div>

    <div style="margin-top:8px;display:flex;gap:6px;align-items:center;">
      <input
        id="chat-input"
        type="text"
        placeholder="メッセージを入力"
        maxlength="100"
        class="chat-input"
      >
      <button id="chat-send" class="chat-send">送信</button>
    </div>
  </div>

<div id="result-overlay" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100vw;
  height:100vh;
  z-index:2000;

  align-items:center;
  justify-content:center;

  pointer-events:none;   /* ← 通常は操作不可 */
">
  <div id="result-panel" style="
    background: rgba(255,255,255,0.92);
    color: black;
    width: 420px;
    max-width: 90vw;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 0 30px rgba(0,0,0,0.4);
    pointer-events:auto;  /* ← パネルだけ操作可能 */
  ">
    <h2 style="text-align:center;margin-top:0;">結果発表</h2>
    <ol id="result-list" style="font-size:18px;"></ol>
    <div style="text-align:center;margin-top:20px;">
      <button onclick="location.reload()">ロビーに戻る</button>
    </div>
  </div>
</div>
</div>
<!-- ゲーム画面の前に重ねる白パネル -->



<script>
let ws;
let myName;
let CTurn = null;

/* ===== 接続 ===== */
function connect() {
  myName = username.value.trim();
  const roomId = roomIdInput.value.trim();
  const maxPlayers = Number(playerCount.value);

  if (!myName || !roomId) return alert("未入力");

  ws = new WebSocket(`wss://my-worker.6322052.workers.dev/room/${roomId}`);

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type:"join_game",
      username:myName,
      maxPlayers
    }));
    login.style.display="none";
    waiting.style.display="block";
    status.textContent="参加者待ち…";
  };

  ws.onmessage = e => handleMessage(JSON.parse(e.data));
}

const login = document.getElementById("login");
const waiting = document.getElementById("waiting");
const game = document.getElementById("game");
const status = document.getElementById("status");
const username = document.getElementById("username");
const roomIdInput = document.getElementById("roomId");
const playerCount = document.getElementById("playerCount");

/* ===== 受信 ===== */
function handleMessage(msg) {
  if (msg.type === "chat") {
    addChat(msg.text);
    return;
  }

  if (msg.type === "waiting") {
    status.textContent = `待機中 ${msg.current}/${msg.max}`;
  }

  if (msg.type === "game_start") {
    waiting.style.display="none";
    game.style.display="flex";
    document.querySelector(".chat-panel").style.display = "flex";
    initTable();
  }

  if (msg.type === "update_table") updateTable(msg);
  if (msg.type === "update_hand") updateHand(msg);
  if (msg.type === "announce_turn") updateTurn(msg);

  if (msg.type === "game_result") {
    showResult(msg.ranks);
  }
}

/* ===== table ===== */
function initTable() {
  table.innerHTML="";
  for(let i=0;i<52;i++){
    const d=document.createElement("div");
    d.className="slot";
    table.appendChild(d);
  }
}
const table=document.getElementById("table");


function safeSend(data) {
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    console.warn("WSは閉じています:", data);
    return;
  }
  ws.send(JSON.stringify(data));
}

/* ===== hand ===== */
function updateHand(d){
  if (d.username !== myName) return;

  hand.innerHTML = "";
  CTurn = d.current_turn;
  const playable = new Set(d.playable);

  /* ===== 絵柄の表示順を完全固定 ===== */
  const suitOrder = {
    H: 0, // hearts
    K: 1, // clubs
    D: 2, // diamonds
    S: 3  // spades
  };

  function parseCard(card) {
    return {
      suit: card[0],                 // H / S / D / K
      suitIndex: suitOrder[card[0]],
      number: Number(card.slice(1))  // 1〜13
    };
  }

  /* ===== 並び替え ===== */
  const sortedHand = [...d.hand].sort((a, b) => {
    const ca = parseCard(a);
    const cb = parseCard(b);

    // ① 絵柄
    if (ca.suitIndex !== cb.suitIndex) {
      return ca.suitIndex - cb.suitIndex;
    }

    // ② 数字
    return ca.number - cb.number;
  });

  /* ===== 表示 ===== */
  sortedHand.forEach(c => {
    const img = document.createElement("img");
    img.src = `images/${c}.png`;
    img.className = "hand-card big-hand";

    if (!playable.has(c) || CTurn !== myName) {
      img.style.opacity = 0.3;
    } else {
      img.onclick = () => safeSend({
        type: "play_card",
        username: myName,
        card: c
      });
    }

    hand.appendChild(img);
  });
}


const hand=document.getElementById("hand");

/* ===== table draw ===== */
function updateTable(d){
  const suits=["hearts","spades","diamonds","clubs"];
  table.innerHTML="";
  for(let i=0;i<52;i++){
    const s=document.createElement("div");
    s.className="slot";
    table.appendChild(s);
  }
  suits.forEach((s,r)=>{
    d.table[s].forEach((c,i)=>{
      if(!c)return;
      const img=document.createElement("img");
      img.src=`images/${c}.png`;
      img.style.width="100%";
      table.children[r*13+i].appendChild(img);
    });
  });
}

let myPass = 0;

let lastTurnData = null;
/* ===== turn ===== */
function updateTurn(d){
  lastTurnData = d;
  playersUi.innerHTML="";
  d.players.forEach(p=>{
    const div=document.createElement("div");
    div.innerHTML = `
      <b style="color:${p===d.player ? 'red' : 'white'}">${p}</b><br>
      残り: ${d.hand_counts[p]}<br>
      パス: ${d.passes[p] ?? 0}/3
    `;
    playersUi.appendChild(div);
  });
  
  myPass = d.passes[myName] ?? 0;
  const isMyTurn = d.player === myName;
  if (!isMyTurn) {
   passBtn.disabled = true;
    passBtn.textContent = "パス";
  } else if (myPass >= 2) {
    passBtn.disabled = false;
        passBtn.textContent = "降参";
  } else {
    passBtn.disabled = false;
    passBtn.textContent = "パス";
  }
  passBtn.style.display=(d.player===myName)?"block":"none";
}
const playersUi=document.getElementById("players-ui");
const passBtn=document.getElementById("pass-btn");


passBtn.onclick = () => {
  if( myPass >= 2 ){
  safeSend({
    type: "resign",
    username: myName
  });
} else {
  safeSend({
    type: "pass_turn",
    username: myName
  })
};

};


//チャット

const chatLog = document.getElementById("chat-log");
const chatInput = document.getElementById("chat-input");
const chatSend = document.getElementById("chat-send");


function addChat(text) {
  const div = document.createElement("div");
  div.textContent = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

/* 送信ボタン */
chatSend.onclick = sendChat;

/* Enterキー送信 */
chatInput.addEventListener("keydown", e => {
  if (e.key === "Enter") sendChat();
});

function sendChat() {
  const text = chatInput.value.trim();
  if (!text) return;

  safeSend({
    type: "chat",
    username: myName,
    text
  });

  chatInput.value = "";
}


const resultOverlay = document.getElementById("result-overlay");
const resultList = document.getElementById("result-list");

function showResult(ranks) {
  console.log("show result", ranks);
  if (!Array.isArray(ranks)) return;

  resultList.innerHTML = "";

  ranks.forEach((name, i) => {
    const li = document.createElement("li");
    li.textContent = `${i + 1}位：${name}`;
    resultList.appendChild(li);
  });

  resultOverlay.style.display = "flex";
}



</script>

</body>
</html>
