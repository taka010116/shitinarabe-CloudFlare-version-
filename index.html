<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>七並べ ONLINE</title>

<style>
body {
  font-family: sans-serif;
  background: #0a7a3b;
  color: #fff;
  margin: 0;
  padding: 20px;
}

h1 { text-align: center; }

.panel {
  max-width: 900px;
  margin: auto;
  background: rgba(0,0,0,0.25);
  padding: 20px;
  border-radius: 8px;
}

label { display:block; margin-top:10px; }
input, select, button {
  width:100%; margin-top:5px; padding:8px; font-size:16px;
}
button { margin-top:15px; cursor:pointer; }

#waiting, #game { display:none; }

#game {
  display: flex;
  flex-direction: row;
  align-items: flex-start;

  max-width: none !important;
  margin: 0 !important;
  padding: 15px;

  width: 100vw;
  box-sizing: border-box;

  overflow: hidden;   /* ← スクロール完全禁止 */
}

#table {
  display: grid;
  grid-template-columns: repeat(13, 52px);
  grid-template-rows: repeat(4, 78px);
  gap: 4px;
  justify-content: center;
  margin: 30px auto;
  background:#0b6623;
  padding:10px;
  border-radius:10px;
}

.slot {
  width:52px; height:78px;
  background:#0a3;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.hand-card {
  width:52px;
  height:78px;
  cursor:pointer;
  transition:transform .15s;
}
.hand-card:hover { transform:translateY(-6px); }

.game-layout {
  display: flex;
  flex-direction: row; 
  gap: 20px;
  align-items: flex-start;
  width: 100%;
}

.game-main {
  /* flex: 1; */
  flex: 0 0 auto; 
  min-width: 700px;
}

.chat-panel {
  position: fixed;      /* ← レイアウトから完全に切り離す */
  top: 20px;            /* ← 右上からの距離 */
  right: 20px;

  width: 260px;
  height: 520px;

  background: rgba(0,0,0,0.7);
  border-radius: 8px;
  padding: 10px;

  display: flex;
  flex-direction: column;

  z-index: 1000;        /* ← ゲームより必ず前 */
}


.chat-panel h3 {
  margin: 0 0 8px 0;
  text-align: center;
}

#chat-log {
  flex: 1;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  padding: 8px;
  overflow-y: auto;
  font-size: 13px;
  line-height: 1.4;
}

#game.panel {
  max-width: none;
}

.chat-box {
  width: 260px;
  height: 520px;
  background: rgba(0,0,0,0.35);
  border-radius: 8px;
  padding: 10px;
  overflow-y: auto;
  flex-shrink: 0;        /* ← 絶対に縮まない */
}

</style>
</head>

<body>



<!-- ===== lobby ===== -->
<div id="login" class="panel">
  <label>ユーザー名 <input id="username"></label>
  <label>ルームID <input id="roomId"></label>
  <label>人数
    <select id="playerCount">
      <option value="2">2人</option>
      <option value="3">3人</option>
      <option value="4">4人</option>
    </select>
  </label>
  <button onclick="connect()">参加</button>
</div>

<div id="waiting" class="panel">
  <h2>待機中</h2>
  <div id="status"></div>
</div>

<!-- ===== game ===== -->
<div id="game" class="panel game-layout">

  <!-- ===== 左：ゲーム ===== -->
  <div class="game-main">
    <div id="players-ui" style="display:flex;gap:20px;justify-content:center;"></div>
    <div id="table"></div>
    <h3>あなたの手札</h3>
    <div id="hand" style="display:flex;gap:6px;justify-content:center;"></div>
    <button id="pass-btn" style="display:none;">パス</button>
  </div>

  <!-- ===== 右：チャット ===== -->
  <div class="chat-panel">
    <h3>Chat Log</h3>
    <div id="chat-log"></div>
  </div>

</div>


<script>
let ws;
let myName;
let CTurn = null;

/* ===== 接続 ===== */
function connect() {
  myName = username.value.trim();
  const roomId = roomIdInput.value.trim();
  const maxPlayers = Number(playerCount.value);

  if (!myName || !roomId) return alert("未入力");

  ws = new WebSocket(`wss://my-worker.6322052.workers.dev/room/${roomId}`);

  ws.onopen = () => {
    ws.send(JSON.stringify({
      type:"join_game",
      username:myName,
      maxPlayers
    }));
    login.style.display="none";
    waiting.style.display="block";
    status.textContent="参加者待ち…";
  };

  ws.onmessage = e => handleMessage(JSON.parse(e.data));
}

const login = document.getElementById("login");
const waiting = document.getElementById("waiting");
const game = document.getElementById("game");
const status = document.getElementById("status");
const username = document.getElementById("username");
const roomIdInput = document.getElementById("roomId");
const playerCount = document.getElementById("playerCount");

/* ===== 受信 ===== */
function handleMessage(msg) {
  if (msg.type === "chat") {
    addChat(msg.text);
    return;
  }

  if (msg.type === "waiting") {
    status.textContent = `待機中 ${msg.current}/${msg.max}`;
  }

  if (msg.type === "game_start") {
    waiting.style.display="none";
    game.style.display="block";
    initTable();
  }

  if (msg.type === "update_table") updateTable(msg);
  if (msg.type === "update_hand") updateHand(msg);
  if (msg.type === "announce_turn") updateTurn(msg);
}

/* ===== table ===== */
function initTable() {
  table.innerHTML="";
  for(let i=0;i<52;i++){
    const d=document.createElement("div");
    d.className="slot";
    table.appendChild(d);
  }
}
const table=document.getElementById("table");


function safeSend(data) {
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    console.warn("WSは閉じています:", data);
    return;
  }
  ws.send(JSON.stringify(data));
}

/* ===== hand ===== */
function updateHand(d){
  if(d.username!==myName)return;

  hand.innerHTML="";
  CTurn=d.current_turn;
  const playable=new Set(d.playable);

  d.hand.forEach(c=>{
    const img=document.createElement("img");
    img.src=`images/${c}.png`;
    img.className="hand-card";

    if(!playable.has(c)||CTurn!==myName){
      img.style.opacity=.3;
    }else{
      /*
      img.onclick=()=>safeSend(JSON.stringify({
        type:"play_card",
        username: myName,
        card:c
      }));
      */
      img.onclick = () => safeSend({
        type: "play_card",
        username: myName,
        card: c
      });

    }
    hand.appendChild(img);
  });
}
const hand=document.getElementById("hand");

/* ===== table draw ===== */
function updateTable(d){
  const suits=["hearts","spades","diamonds","clubs"];
  table.innerHTML="";
  for(let i=0;i<52;i++){
    const s=document.createElement("div");
    s.className="slot";
    table.appendChild(s);
  }
  suits.forEach((s,r)=>{
    d.table[s].forEach((c,i)=>{
      if(!c)return;
      const img=document.createElement("img");
      img.src=`images/${c}.png`;
      img.style.width="100%";
      table.children[r*13+i].appendChild(img);
    });
  });
}

let myPass = 0;

let lastTurnData = null;
/* ===== turn ===== */
function updateTurn(d){
  lastTurnData = d;
  playersUi.innerHTML="";
  d.players.forEach(p=>{
    const div=document.createElement("div");
    div.innerHTML = `
      <b style="color:${p===d.player ? 'red' : 'white'}">${p}</b><br>
      残り: ${d.hand_counts[p]}<br>
      パス: ${d.passes[p] ?? 0}/3
    `;
    playersUi.appendChild(div);
  });
  
  myPass = d.passes[myName] ?? 0;
  const isMyTurn = d.player === myName;
  if (!isMyTurn) {
   passBtn.disabled = true;
    passBtn.textContent = "パス";
  } else if (myPass >= 2) {
    passBtn.disabled = false;
        passBtn.textContent = "降参";
  } else {
    passBtn.disabled = false;
    passBtn.textContent = "パス";
  }
  passBtn.style.display=(d.player===myName)?"block":"none";
}
const playersUi=document.getElementById("players-ui");
const passBtn=document.getElementById("pass-btn");


passBtn.onclick = () => {
  if( myPass >= 2 ){
  safeSend({
    type: "resign",
    username: myName
  });
} else {
  safeSend({
    type: "pass_turn",
    username: myName
  })
};

};


const chatLog = document.getElementById("chat-log");

function addChat(text) {
  const div = document.createElement("div");
  div.textContent = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}


</script>

</body>
</html>
